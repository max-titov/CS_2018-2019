
import java.awt.Color;
import java.awt.Font;
import java.awt.Graphics;
import java.awt.image.BufferedImage;
import java.io.File;
import java.io.IOException;
import java.util.ArrayList;

import javax.imageio.ImageIO;
import javax.swing.JPanel;
import javax.swing.SwingUtilities;

public class PanelBlackjack extends JPanel {

	public static final int WIDTH = 1536;
	public static final int HEIGHT = 864;
	public static final Color BACKGROUND = new Color(0, 128, 43);

	public static final int CARD_WIDTH = 500;
	public static final int CARD_HEIGHT = 726;
	public static final double CARD_SIZE = 0.25;

	private final int delayLength = 50;

	private BufferedImage image;

	private BlackjackGameManager manager;

	private int numberOfPlayers;

	public PanelBlackjack() {
		numberOfPlayers = 2;
		// initialize manager
		manager = new BlackjackGameManager(numberOfPlayers, this);

		// set up graphics
		getPanelGraphics();

		// starting game thread
		Thread gameThread = new Thread(new GameRunnable());
		gameThread.start();
	}

	public void paintComponent(Graphics g) {
		g.drawImage(image, 0, 0, getWidth(), getHeight(), null);
	}

	private Graphics getPanelGraphics() {

		if (null == image) {
			image = new BufferedImage(WIDTH, HEIGHT, BufferedImage.TYPE_INT_RGB);
		}
		Graphics graphics = image.getGraphics();
		graphics.setColor(BACKGROUND);
		graphics.fillRect(0, 0, WIDTH, HEIGHT);
		return graphics;

	}

	public class GameRunnable implements Runnable {

		public void run() {
			manager.playRound();
			try {
				Thread.sleep(10);
			} catch (InterruptedException ex) {
				Thread.currentThread().interrupt();
			}
		}
	}

	public void updateGraphics() {
		try {
			SwingUtilities.invokeAndWait(new Runnable() {
				@Override
				public void run() {
					draw();
					try {
						Thread.sleep(delayLength);
					} catch (InterruptedException ex) {
						Thread.currentThread().interrupt();
					}
				}
			});
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	public void draw() {
		Graphics g = getPanelGraphics();
		ArrayList<BlackjackPlayer> players = manager.getPlayers();
		BlackjackPlayer dealer = manager.getDealer();

		for (int i = 0; i < players.size(); i++) { // iterates through all players
			g.setColor(Color.BLACK);
			g.setFont(new Font("SansSerif", Font.BOLD, 32));
			g.drawString(players.get(i).getName(), 50 + i * 200, 470);
			ArrayList<Card> hand = players.get(i).getHand();
			for (int c = 0; c < hand.size(); c++) {// iterates through all cards
				int x = 50 + i * 200 + c * 25;
				int y = 500 + c * 25;
				drawCard(g, hand.get(c), x, y, 0.25);
			}
		}
		ArrayList<Card> dealerHand = dealer.getHand();
		for (int c = 0; c < dealerHand.size(); c++) {
			int x = (int) (WIDTH / 2.5 + c * 25);
			int y = 100;
			drawCard(g, dealerHand.get(c), x, y, 0.25);
		}

		repaint();

//		try {
//			Thread.sleep(20); // sleep for 20 milliseconds
//		} catch (Exception e) {
//			e.printStackTrace();
//		}
	}

	public void drawCard(Graphics g, Card card, int x, int y, double size) {
		if (card.isFaceUp()) {
			try {
				BufferedImage cardImage = ImageIO.read(new File("src/card_images/" + card.getSimple() + ".png"));
				double scalar = 1 / size;
				g.drawImage(cardImage, x, y, (int) (CARD_WIDTH / scalar), (int) (CARD_HEIGHT / scalar), null);
			} catch (IOException ex) {
				System.out.println("could not find image: " + card.getSimple() + ".png");
			}
		} else {
			double scalar = 1 / size;
			g.setColor(Color.gray.darker());
			g.fillRect(x, y, (int) (CARD_WIDTH / scalar), (int) (CARD_HEIGHT / scalar));
		}
	}

}
